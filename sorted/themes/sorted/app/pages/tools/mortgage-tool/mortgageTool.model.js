"use strict";angular.module("sorted").factory("MortgageToolModel",["siteConfig","NgBackboneModel","NgBackboneCollection",function(t,e,n){var r="",s=e.extend({initialize:function(t,e){_.has(e,"parent")&&(this.parent=e.parent),this.on("change:total",function(){var t=parseInt(this.get("total")),e=parseInt(this.parent.get("lump_sum_repayment"));if(_.isInteger(t)&&_.isInteger(e)){var n=_.add(t,e);this.set({total:n},{silent:!0})}}),this.listenTo(this.parent,"change:repayments1",function(){var t=_.round(this.parent.get("repayments1"));t!==_.round(this.get("min_repayment"))&&this.set({min_repayment:t},{silent:!0})})},calcResult:function(){var t=this;return _.reduce(t.pick(["total","interest"]),function(t,e){return _.isNaN(e)?t:_.add(t,parseInt(e))},0)},hasResult:function(){return this.calcResult()}}),a=e.extend({constructor:function(){this.result=new s(null,{parent:this}),e.apply(this,arguments)},initialize:function(t,e){_.has(e,"mortgageRepayment")&&(this.mortgageRepayment=e.mortgageRepayment),_.has(e,"mortgageManager")&&(this.mortgageManager=e.mortgageManager),this.on("change:year_born change:month_born",function(t){var e=_.clone(t.changed),n=_.transform(e,function(t,e,n){t[n]=isNaN(e)?null:parseInt(e)},{});t.set(n,{silent:!0})}),this.listenTo(this.result,"change",function(){this.trigger("result:change",this)}),this.listenTo(this.result,"change:min_repayment",function(){this.result.get("min_repayment")!==this.get("repayments1")&&this.set({repayments1:_.round(this.result.get("min_repayment"))},{silent:!0})}),this.listenTo(this.result,"change:time",function(){var t=parseInt(this.get("term1")),e=_.round(this.result.get("time"));e!==t&&this.set({term1:e},{silent:!0})})},parse:function(t,e){var n=this,r=e||{};return _.has(t.result,"result")&&n.result.set(_.pick(t,"result"),r),t&&(t.id=parseInt(t.unique.substr(t.unique.length-1))-1),_.omit(t,["result"])},calculate:function(){var t=this._getCalculator().calculate(this._prepare(this.attributes));return t.mortgage1.time=Math.ceil(t.mortgage1.time),this.result.set(t.mortgage1),this},calculateSlider:function(t){var e=this.pick(["loan1","interest1","freq1","lump_sum_repayment"]);return e.term1=t,e.lump_sum_repayment>0&&(e.loan1=e.loan1-e.lump_sum_repayment),this.mortgageRepayment.calculate(e).mortgage1.min_repayment},_getCalculator:function(){return this.hasChanged("repayments1")&&!this.hasChanged("term1")?r="mortgageManager":this.hasChanged("term1")&&!this.hasChanged("repayments1")&&(r="mortgageRepayment"),r||(r="mortgageManager"),this[r]},_prepare:function(t){var e,n,r=_.pick(_.clone(t),["loan1","interest1","repayments1","freq1","term1","lump_sum_repayment","year_born1","month_born1"]),s=_.merge(r,{loan1:r.loan1-r.lump_sum_repayment,lump_sum_repayment:0});return this.collection.models[0].attributes.year_born1&&this.collection.models[0].attributes.month_born1?(e=this.collection.models[0].attributes.month_born1,n=this.collection.models[0].attributes.year_born1):this.collection.models[1].attributes.year_born1&&this.collection.models[1].attributes.month_born1?(e=this.collection.models[1].attributes.month_born1,n=this.collection.models[1].attributes.year_born1):this.collection.models[2].attributes.year_born1&&this.collection.models[2].attributes.month_born1&&(e=this.collection.models[2].attributes.month_born1,n=this.collection.models[2].attributes.year_born1),e&&n&&(this.collection.models[0].attributes.month_born1=e,this.collection.models[0].attributes.year_born1=n,this.collection.models[1].attributes.month_born1=e,this.collection.models[1].attributes.year_born1=n,this.collection.models[2].attributes.month_born1=e,this.collection.models[2].attributes.year_born1=n),s.year_born1=n,s.month_born1=e,s},calcMinRepaymentAmt:function(){var t=this.pick(["loan1","interest1","freq1"]);return _.merge(t,{term1:30}),this.mortgageRepayment.calculate(t).mortgage1.min_repayment},hasResult:function(){return this.result.hasResult()},validate:function(){if(!this.hasResult())return"Invalid"},toJSON:function(){var t=e.prototype.toJSON.apply(this,arguments);return _.merge(t,{result:this.result.toJSON()})}}),i=n.extend({model:a,initialize:function(t,e){_.has(e,["parent"])&&(this.parent=e.parent)},hasResult:function(){return!!this.find(function(t){return t.hasResult()})}});return e.extend({idAttribute:"ID",urlRoot:t.API_PREFIX,defaults:{Title:"My Mortgage Calculator"},url:function(){var t=this.urlRoot+"/rest/tool";return this.isNew()?t:t+"/"+this.get("ID")},constructor:function(){this.collection=new i(null,{parent:this}),e.apply(this,arguments)},parse:function(t,e){var n=this,r={};return r=_.has(t,"status")&&_.has(t,"data")?t.data:t,_.has(r,"Data")?n.collection.set(r.Data,e):_.has(r,"models")&&n.collection.set(r.models,e),_.has(r,"ID")&&_.merge(r,{ID:_.toString(r.ID)}),_.omit(r,["Data","models"])},hasResult:function(){return this.collection.hasResult()},toJSON:function(){var t=e.prototype.toJSON.apply(this,arguments);return _.merge(t,{Data:this.collection.toJSON()})}})}]);