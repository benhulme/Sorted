angular.module("sorted").factory("KiwisaverFeesModel",["siteConfig","NgBackboneModel","NgBackboneCollection",function(t,e,n){"use strict";var a=e.extend({defaults:{compare:0},initialize:function(){this.on("change:compare",function(){},this)}}),i=n.extend({model:a}),r=n.extend({model:a}),o=e.extend({constructor:function(){this.todays=new r,this.nominal=new i,e.apply(this,arguments)},initialize:function(){this.listenTo(this.todays,"change",function(){this.trigger("result:change")})},parse:function(t,e){var n=[],a=[];return _.forEach(t,function(t){n.push(t.todays),a.push(t.nominal)}),this.todays.reset(n,e),this.nominal.reset(a,e),t},reset:function(t,e){return this.parse(t,e||{}),this},hasResult:function(){return!0},toJSON:function(){return _.merge({},{todays:this.todays.toJSON()},{nominal:this.nominal.toJSON()})}});return e.extend({idAttribute:"ID",defaults:{Title:"KiwiSaver fees calculator"},urlRoot:t.API_PREFIX,url:function(){var t=this.urlRoot+"/rest/tool";return this.isNew()?t:t+"/"+this.get("ID")},constructor:function(){this.result=new o,e.apply(this,arguments)},initialize:function(e,n){_.has(n,"calculator")&&(this.calculator=n.calculator),this.on("change:year_born change:month_born",function(e){if(e.has("year_born")&&e.has("month_born")){var n="01/"+e.get("month_born")+"/"+e.get("year_born"),a=moment(n,t.DATE_FORMAT);a.isValid()&&e.set("my_birthdate",a.format(t.DATE_FORMAT))}})},parse:function(t){var e={};return _.has(t,"status")&&_.has(t,"data")?(e=t.data,_.has(e,"Data")&&(e=e.Data,_.merge(e,_.pick(t.data.Data,"Title"),_.pick(t.data,"ID")))):e=t,_.omit(e,["result","Data"])},loadDummyData:function(t){return this.calculate(t)},calculate:function(t){var e=this,n=$.Deferred(),a=t||this._prepare();return $(document).on("ksfcalcend",function(){return e.calculating=!1,e.result.reset(e.calculator.model.results),n.resolve(e)}),this.calculator.calculate(a),n.promise()},_prepare:function(){var t=_.clone(this.attributes);return _.merge(t,{employment:"1"===t.employment,iac:1===t.iac})},hasResult:function(){return this.result.nominal.length>0&&this.result.todays.length>0},toJSON:function(){var t=e.prototype.toJSON.apply(this,arguments);return _.merge({Data:t},_.pick(t,"CalcID"),_.has(t,"Title")?_.pick(t,"Title"):{Title:"My KiwiSaver Fees calculation"})},validate:function(t){function e(t){var e=[];return _.forEach(t,function(t,n){if(!_.isNumber(t)&&_.isEmpty(t))return e.push(n)}),e.length}if("1"===t.employment){if(e(_.omit(t,["earnings","contrib","contrib_freq"])))return"Invalid"}else if("1"!==t.employment&&e(_.omit(t,["salary","employee_contrib","employer_contrib"])))return"Invalid"}})}]);